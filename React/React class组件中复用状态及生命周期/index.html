<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="baidu-site-verification" content="code-huaq5qAbeF"><title>React class组件中复用状态及生命周期 - 小春日和の秘密基地</title><meta name="description" content="原来Class组件也是可以复用生命周期中的逻辑的。"><link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@5.8.55/css/materialdesignicons.min.css"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><link rel="stylesheet" href="/libs/normalize.css?timestamp=1714273544228"><link rel="stylesheet" href="/libs/flex.css?timestamp=1714273544228"><link rel="stylesheet" href="/libs/material-components-web.min.css?timestamp=1714273544228"><link rel="stylesheet" href="/libs/mdc.tooltip.min.css?timestamp=1714273544228"><link rel="stylesheet" href="/libs/prism.css?timestamp=1714273544228"><link rel="stylesheet" href="/libs/viewer.min.css?timestamp=1714273544228"><link rel="stylesheet" href="/styles/commons/index.css?timestamp=1714273544228"><link rel="stylesheet" href="/styles/templates/index.css?timestamp=1714273544228"><link rel="stylesheet" href="/styles/partial/index.css?timestamp=1714273544228"><link rel="stylesheet" href="/styles/layout.css?timestamp=1714273544228"><script src="/libs/jquery.min.js?timestamp=1714273544228"></script><script src="/libs/material-components-web.min.js?timestamp=1714273544228"></script><script src="/libs/mdc.tooltip.min.js?timestamp=1714273544228"></script><script src="/libs/prism.min.js?timestamp=1714273544228"></script><script src="/libs/viewer.min.js?timestamp=1714273544228"></script><script src="/scripts/uiRender.js?timestamp=1714273544228"></script><meta name="generator" content="Hexo 5.0.2"></head><body><img class="page-bgImg" src="/sourceImages/bg.png"><header class="mdc-top-app-bar mdc-top-app-bar--fixed mdc-elevation--z4"><div class="mdc-top-app-bar__row"><section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start"><button id="drawerButton" class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button">menu</button> <a class="mdc-top-app-bar__title" href="/" style="color:#fff">小春日和の秘密基地</a></section><section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end"><button id="searchButton" class="material-icons mdc-top-app-bar__action-item mdc-icon-button">search</button></section></div></header><div class="mainContainer flex-row"><div class="page-drawer"><div class="drawer-placeholder"></div><aside class="mdc-drawer drawer-body mdc-elevation--z4"><div class="drawer-header flex-column flex-evenly"><div class="drawer-header--content flex-column flex-cross-center"><img class="drawer-avatar" src="/sourceImages/avatar.png"><div class="drawer-userName">小春日和</div><div class="drawer-totals flex-row flex-cross-center"><div class="flex flex-column flex-center"><div class="drawer-totals--label">文章</div><div class="drawer-totals--value">共14篇</div></div><div class="flex flex-column flex-center"><div class="drawer-totals--label">标签</div><div class="drawer-totals--value">共12个</div></div><div class="flex flex-column flex-center" id="busuanzi_container_site_pv"><div class="drawer-totals--label" style="text-align:center">总访问</div><div class="drawer-totals--value" style="text-align:center"><span id="busuanzi_value_site_pv"></span><span>次</span></div></div></div></div></div><div class="drawer-content"><div class="drawer-list"><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" href="/"><i class="list-item--icon material-icons">home</i><span class="list-item--title">首页</span></a><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" href="/日常/再次启程"><i class="list-item--icon material-icons">info</i><span class="list-item--title">关于博客 </span></a><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" target="_blank" rel="noopener" href="https://github.com/koharubiyori"><i class="mdi-set mdi-github" style="font-size:24px;color:var(--mdc-theme-primary);line-height:1.1"></i><span class="list-item--title">Github</span></a><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" target="_blank" rel="noopener" href="https://zh.moegirl.org.cn/User:%E6%9D%B1%E6%9D%B1%E5%90%9B"><strong style="font-size:18px;color:var(--mdc-theme-primary);margin-left:3px">萌</strong><span class="list-item--title">萌娘百科</span></a></div></div></aside></div><main class="mainContent flex"><div class="page-post"><link rel="stylesheet" href="/styles/post.css?timestamp=1714273544201"><div class="post-header"><h2 class="post-header--title">React class组件中复用状态及生命周期</h2><div class="post-header--row com-onlyDesktop"><div class="post-header--infoBox" style="background-color:#007fff"><i class="material-icons">watch_later</i><span>2020年12月04日</span></div><div class="post-header--infoBox" style="background-color:#04b431"><i class="material-icons">menu_book</i><span>总字数：856</span></div><div class="post-header--infoBox" style="background-color:#b40486"><i class="material-icons">access_alarm</i><span>预计阅读时间：10分钟</span></div></div><div class="post-header--row post-header--tags" style="justify-content:flex-start;margin-top:10px"><a class="post-header--tag" href="/tags/React/" title="查看“React”标签下的文章"><i class="material-icons">local_offer</i><span>React</span></a></div></div><div class="post-body mdc-elevation--z2"><img class="post-body--headImg" src="https://bn1302files.storage.live.com/y4meAs82SLn1J0nYxN49RYg487VNNRI6IfTj6yQYbgFXjQy0l0epUKismPOGEowPPfc5UtrlHcDsxq5bfDQDBm5OM_O2RmjuK0efTsmfEtxGMAzAJ0UJHDXm6uUg-rGK8c1auhHND4MUgJjvm9QjSDvlgAfXd-yASat-xT6_DdI4vQJjc9bJdFK9oD9rfqpw81U?width=1024&amp;height=724&amp;cropmode=none" style="object-position:undefined"><div class="post-body--content"><div class="contentContainer"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>用过React hooks的人一定都感受到了使用hooks封装组件状态及声明周期所带来的代码清晰度提升以及使用上的便利。在早些版本的React中，React使用createClass创建组件，其中提供了一个mixins属性，可以将多个组件中的属性与声明周期混合，后来随着es6 class的普及，官方也不在推荐使用createClass来创建组件。虽然es6 class本身无法实现mixins的特性，但通过高阶组件也是可以复用状态及生命周期的。</p><h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>一般情况下，高阶组件大多是像下面这种代码，在返回的新组件中使用传来的组件，用来封装context，从而比较方便地实现依赖注入：</p><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx">function HOC(Component) &#123;
  return function WrappedComponent(props) &#123;
    return (
      &lt;MyContext.Consumer&gt;&#123;context &#x3D;&gt;
        &lt;Component &#123;...props&#125; prop1&#x3D;&#123;context&#125;&gt;
      &#125;&lt;&#x2F;MyContext.Consumer&gt;
    )
  &#125;
&#125;</code></pre><p>如果在高阶组件中利用继承的话，就可以比较好地实现对状态和声明周期中逻辑的封装：</p><pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx">function HOC(Component) &#123;
  &#x2F;&#x2F; 直接继承要包装的组件
  return class WrappedComponent extends Component &#123;
    constructor(props) &#123;
      super(props)

      &#x2F;*
        这样在被包装组件内就可以访问到了，
        不过有一点要注意，在构造函数中，因为如果要访问this必须先调用一次父类的构造函数[super(props)]，
        这样也就导致了被包装类在构造函数中的this上访问不到这里向this注入的属性，
        有两个办法可以解决：
          1. 将注入的属性同时混入到将要传给super的props中
          2. 被包装类不在构造函数中注入的属性，改为在componentWillMount中使用
      *&#x2F;
      this.data &#x3D; &#123; a: 1 &#125;

      this.state.incrementVal &#x3D; 0
      this.intervalKey &#x3D; 0
    &#125;

    &#x2F;&#x2F; 使用声明周期逻辑，如果使用了内部就必须调用父类同名声明周期钩子
    componentDidMount() &#123;
      &#x2F;&#x2F; 需要判断被包裹组件是否有对应的生命周期钩子
      super.componentDidMount &amp;&amp; super.componentDidMount()

      this.intervalKey &#x3D; setInterval(() &#x3D;&gt; &#123;
        this.setState(prevState &#x3D;&gt; (&#123;
          incrementVal: prevState.incrementVal + 1
        &#125;))
      &#125;, 1000)
    &#125;

    componentWillUnmount() &#123;
      super.componentWillUnmount &amp;&amp; super.componentWillUnmount()

      clearInterval(this.intervalKey)
    &#125;
  &#125;
&#125;</code></pre><h2 id="实现包装类私有属性"><a href="#实现包装类私有属性" class="headerlink" title="实现包装类私有属性"></a>实现包装类私有属性</h2><p>大家可能已经发现了，在上面的写法中，被包裹组件内部是可以通过<code>this.intervalKey</code>访问到这个只在包装类中用到的属性，<br>这样不仅降低了封装性，而且容易和其他属性发生冲突，造成难以排查的错误，所以我们还需要个让包装类拥有私有属性的办法。</p><h3 id="配置Babel插件使用Stage-3提案中的私有属性写法"><a href="#配置Babel插件使用Stage-3提案中的私有属性写法" class="headerlink" title="配置Babel插件使用Stage-3提案中的私有属性写法"></a>配置Babel插件使用Stage-3提案中的私有属性写法</h3><pre class="line-numbers language-ts" data-language="ts"><code class="language-ts">function HOC(Component) &#123;
  return class WrappedComponent extends Component &#123;
    constructor() &#123;
      this.#intervalKey &#x3D; 0  &#x2F;&#x2F; 使用#号开头命名属性即可
    &#125;
  &#125;
&#125;</code></pre><h3 id="使用Symbol实现私有属性"><a href="#使用Symbol实现私有属性" class="headerlink" title="使用Symbol实现私有属性"></a>使用Symbol实现私有属性</h3><pre class="line-numbers language-ts" data-language="ts"><code class="language-ts">function HOC(Component) &#123;
  const intervalKey &#x3D; Symbol()

  return class WrappedComponent extends Component &#123;
    constructor() &#123;
      this[intervalKey] &#x3D; 0
    &#125;  
  &#125;
&#125;</code></pre><h3 id="使用散列表实现私有属性"><a href="#使用散列表实现私有属性" class="headerlink" title="使用散列表实现私有属性"></a>使用散列表实现私有属性</h3><pre class="line-numbers language-ts" data-language="ts"><code class="language-ts">function HOC(Component) &#123;
  &#x2F;&#x2F; 使用类实例作为键，保存每个组件实例的私有属性
  &#x2F;&#x2F; 不要使用Map，理由见：https:&#x2F;&#x2F;developer.mozilla.org&#x2F;zh-CN&#x2F;docs&#x2F;Web&#x2F;JavaScript&#x2F;Reference&#x2F;Global_Objects&#x2F;WeakMap#Why_WeakMap
  const privateSpace &#x3D; WeakMap()

  return class WrappedComponent extends Component &#123;
    constructor() &#123;
      privateSpace[this].set(intervalKey, 0)
    &#125;
  &#125;
&#125;</code></pre><h3 id="TypeScript支持"><a href="#TypeScript支持" class="headerlink" title="TypeScript支持"></a>TypeScript支持</h3><p>见：<a href="/2020/12/04/React/%E5%9C%A8React%E4%B8%AD%E6%84%89%E5%BF%AB%E5%9C%B0%E4%BD%BF%E7%94%A8TypeScript#%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%E6%B3%A8%E5%85%A5%E7%B1%BB%E5%9E%8B">在React中愉快地使用TypeScript#高阶组件注入类型</a></p></div><div class="articleLicenses"><p>版权声明：本文为原创文章，版权归 小春日和 所有</p><p style="word-break:break-all"><span>文章链接：</span><a id="articleLink" href="javascript:void()" aria-describedby="tooltip-copyArticleLink">https://koharubiyori.github.io/React/React class组件中复用状态及生命周期/</a></p><p><span>所有原创文章采用&nbsp;</span><a target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh">署名-非商业性使用 4.0 国际 (CC BY-NC 4.0)</a></p><p>您可以自由转载和修改，但必须保证在显著位置注明文章来源，且不能用于商业目的。</p><div id="tooltip-copyArticleLink" class="mdc-tooltip" role="tooltip" aria-hidden="true"><div class="mdc-tooltip__surface"><lorem>点击复制链接</lorem></div></div></div></div></div><div class="prevNextArticle flex-row flex-between"><a class="nextArticle materialRipple materialRipple--dark mdc-elevation--z2 flex" href="/小程序/Taro下基于hooks的导航器封装/" title="Taro下基于hooks的导航器封装"><div class="label">上一篇</div><div class="title com-textLimit">Taro下基于hooks的导航器封装</div></a><a class="prevArticle materialRipple materialRipple--dark mdc-elevation--z2 flex" href="/React/在React中愉快地使用TypeScript/" title="在React中愉快地使用TypeScript"><div class="label">下一篇</div><div class="title com-textLimit">在React中愉快地使用TypeScript</div></a></div><div id="post-comments"></div></div></main><div class="page-sidebar"><div class="sidebar-placeholder"></div><div class="sidebar-body mdc-elevation--z4"><div class="articleContents"><div class="articleContents-title">目录</div></div><div class="katakoto"><div class="katakoto-title">只言片语</div><div class="katakoto-items"><div class="katakoto-item"><div class="katakoto-item--content">第三次重建博客，希望这次不会没写多少东西就又关了...</div><div class="katakoto-item--date">—— 2020年11月21日 09:35</div></div><div class="katakoto-item"><div class="katakoto-item--content">其实我写博客是为了发图的...なんちゃって</div><div class="katakoto-item--date">—— 2020年12月05日 23:35</div></div><div class="katakoto-item"><div class="katakoto-item--content">希望以后每天都能开心...</div><div class="katakoto-item--date">—— 2020年12月07日 10:14</div></div><div class="katakoto-item"><div class="katakoto-item--content">少想多做。</div><div class="katakoto-item--date">—— 2022年07月03日 00:14</div></div></div></div><div class="tags"><div class="tags-title">内容标签</div><a class="tags-item" href="/tags/Electron/" title="查看“Electron”标签下的文章"><i class="material-icons">local_offer</i><span>Electron</span></a><a class="tags-item" href="/tags/JavaScript/" title="查看“JavaScript”标签下的文章"><i class="material-icons">local_offer</i><span>JavaScript</span></a><a class="tags-item" href="/tags/TypeScript/" title="查看“TypeScript”标签下的文章"><i class="material-icons">local_offer</i><span>TypeScript</span></a><a class="tags-item" href="/tags/前端/" title="查看“前端”标签下的文章"><i class="material-icons">local_offer</i><span>前端</span></a><a class="tags-item" href="/tags/Flutter/" title="查看“Flutter”标签下的文章"><i class="material-icons">local_offer</i><span>Flutter</span></a><a class="tags-item" href="/tags/React/" title="查看“React”标签下的文章"><i class="material-icons">local_offer</i><span>React</span></a><a class="tags-item" href="/tags/Vue-js/" title="查看“Vue.js”标签下的文章"><i class="material-icons">local_offer</i><span>Vue.js</span></a><a class="tags-item" href="/tags/前端技术/" title="查看“前端技术”标签下的文章"><i class="material-icons">local_offer</i><span>前端技术</span></a><a class="tags-item" href="/tags/Windows/" title="查看“Windows”标签下的文章"><i class="material-icons">local_offer</i><span>Windows</span></a><a class="tags-item" href="/tags/日常/" title="查看“日常”标签下的文章"><i class="material-icons">local_offer</i><span>日常</span></a><a class="tags-item" href="/tags/小程序/" title="查看“小程序”标签下的文章"><i class="material-icons">local_offer</i><span>小程序</span></a><a class="tags-item" href="/tags/Taro/" title="查看“Taro”标签下的文章"><i class="material-icons">local_offer</i><span>Taro</span></a></div></div></div><div class="page-search"><div class="search-body"><div class="search-input-container flex-row flex-cross-center"><i class="material-icons">search</i><input class="search-input flex" placeholder="搜索文章..."></div><div class="search-result" data-dirty="false" data-emptyresult="false"></div></div></div></div><div class="backTopButton mdc-elevation--z4 flex-row flex-center is-hide materialRipple"><i class="material-icons">north</i></div></body></html>