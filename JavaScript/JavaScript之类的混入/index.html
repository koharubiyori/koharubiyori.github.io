<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="baidu-site-verification" content="code-huaq5qAbeF"><title>JavaScript之“类的混入” - 小春日和の秘密基地</title><meta name="description" content="精神一到何事か成らざらん！"><link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@5.8.55/css/materialdesignicons.min.css"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><link rel="stylesheet" href="/libs/normalize.css?timestamp=1681183437305"><link rel="stylesheet" href="/libs/flex.css?timestamp=1681183437305"><link rel="stylesheet" href="/libs/material-components-web.min.css?timestamp=1681183437305"><link rel="stylesheet" href="/libs/mdc.tooltip.min.css?timestamp=1681183437305"><link rel="stylesheet" href="/libs/prism.css?timestamp=1681183437305"><link rel="stylesheet" href="/libs/viewer.min.css?timestamp=1681183437305"><link rel="stylesheet" href="/styles/commons/index.css?timestamp=1681183437305"><link rel="stylesheet" href="/styles/templates/index.css?timestamp=1681183437305"><link rel="stylesheet" href="/styles/partial/index.css?timestamp=1681183437305"><link rel="stylesheet" href="/styles/layout.css?timestamp=1681183437305"><script src="/libs/jquery.min.js?timestamp=1681183437305"></script><script src="/libs/material-components-web.min.js?timestamp=1681183437305"></script><script src="/libs/mdc.tooltip.min.js?timestamp=1681183437305"></script><script src="/libs/prism.min.js?timestamp=1681183437305"></script><script src="/libs/viewer.min.js?timestamp=1681183437305"></script><script src="/scripts/uiRender.js?timestamp=1681183437305"></script><meta name="generator" content="Hexo 5.0.2"></head><body><img class="page-bgImg" src="/sourceImages/bg.png"><header class="mdc-top-app-bar mdc-top-app-bar--fixed mdc-elevation--z4"><div class="mdc-top-app-bar__row"><section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start"><button id="drawerButton" class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button">menu</button> <a class="mdc-top-app-bar__title" href="/" style="color:#fff">小春日和の秘密基地</a></section><section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end"><button id="searchButton" class="material-icons mdc-top-app-bar__action-item mdc-icon-button">search</button></section></div></header><div class="mainContainer flex-row"><div class="page-drawer"><div class="drawer-placeholder"></div><aside class="mdc-drawer drawer-body mdc-elevation--z4"><div class="drawer-header flex-column flex-evenly"><div class="drawer-header--content flex-column flex-cross-center"><img class="drawer-avatar" src="/sourceImages/avatar.png"><div class="drawer-userName">小春日和</div><div class="drawer-totals flex-row flex-cross-center"><div class="flex flex-column flex-center"><div class="drawer-totals--label">文章</div><div class="drawer-totals--value">共14篇</div></div><div class="flex flex-column flex-center"><div class="drawer-totals--label">标签</div><div class="drawer-totals--value">共12个</div></div><div class="flex flex-column flex-center" id="busuanzi_container_site_pv"><div class="drawer-totals--label" style="text-align:center">总访问</div><div class="drawer-totals--value" style="text-align:center"><span id="busuanzi_value_site_pv"></span><span>次</span></div></div></div></div></div><div class="drawer-content"><div class="drawer-list"><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" href="/"><i class="list-item--icon material-icons">home</i><span class="list-item--title">首页</span></a><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" href="/2020/08/24/日常/再次启程"><i class="list-item--icon material-icons">info</i><span class="list-item--title">关于博客 </span></a><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" target="_blank" rel="noopener" href="https://github.com/koharubiyori"><i class="mdi-set mdi-github" style="font-size:24px;color:var(--mdc-theme-primary);line-height:1.1"></i><span class="list-item--title">Github</span></a><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" target="_blank" rel="noopener" href="https://zh.moegirl.org.cn/User:%E6%9D%B1%E6%9D%B1%E5%90%9B"><strong style="font-size:18px;color:var(--mdc-theme-primary);margin-left:3px">萌</strong><span class="list-item--title">萌娘百科</span></a></div></div></aside></div><main class="mainContent flex"><div class="page-post"><link rel="stylesheet" href="/styles/post.css?timestamp=1681183437276"><div class="post-header"><h2 class="post-header--title">JavaScript之“类的混入”</h2><div class="post-header--row com-onlyDesktop"><div class="post-header--infoBox" style="background-color:#007fff"><i class="material-icons">watch_later</i><span>2022年07月02日</span></div><div class="post-header--infoBox" style="background-color:#04b431"><i class="material-icons">menu_book</i><span>总字数：2.1k</span></div><div class="post-header--infoBox" style="background-color:#b40486"><i class="material-icons">access_alarm</i><span>预计阅读时间：25分钟</span></div></div><div class="post-header--row post-header--tags" style="justify-content:flex-start;margin-top:10px"><a class="post-header--tag" href="/tags/JavaScript/" title="查看“JavaScript”标签下的文章"><i class="material-icons">local_offer</i><span>JavaScript</span></a><a class="post-header--tag" href="/tags/TypeScript/" title="查看“TypeScript”标签下的文章"><i class="material-icons">local_offer</i><span>TypeScript</span></a></div></div><div class="post-body mdc-elevation--z2"><img class="post-body--headImg" src="https://snz04pap001files.storage.live.com/y4mM47mDmDsdM3L_3fGx1eNgiK5_dLoZkT8aHaYUS_dnSiAB_Y8aQ4Zqy8g-gJwJ1fz6av404Idi42bW64_f2gQ03TyW1Q0wZuGsh_A84KHN44wSfq0E40dDY_PDoKDgbl1F41nv8yL3zsH_vr67pchz4gHhLaHcA2wbgI2ViQVV_IIWzPI2Z6_HB-7H3lTqeKh?width=1024&amp;height=570&amp;cropmode=none" style="object-position:undefined"><div class="post-body--content"><div class="contentContainer"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>“混入类”这个概念可能对某些小伙伴比较陌生，如你所知JS是一门只支持单继承的语言，这就导致一个问题：如果想要为一个类及其子类封装多个功能，只能通过多次继承或全部写在父类中来实现。虽然可以勉强解决问题，但前者在类定义时，将不得不定义大量的中间类，并且需要手动维护每个中间类之间父子关系，这样就又导致了封装好的类难以复用；后者则会导致不需要相应功能的子类继承到了无用功能。此时“混入类”这个概念就派上用场了。</p><blockquote><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes#mix-ins_%E6%B7%B7%E5%85%A5">MDN中对于“类的Mix-ins / 混入”的介绍</a></p></blockquote><p>如果你使用过Vue或React的话应该会发现，他们都有一个“混入”的概念，可以参考<a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#mixins">Vue的Mixins API</a>和<a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/react-without-es6.html#mixins">React的Mixins API</a>（不过很遗憾这两个库目前都不推荐在应用代码中使用混入API了，因为被认为大多数情况会降低可维护性，这是只是举例便于理解）。混入实际上就是将一组封装好的功能类附加到了被混入的类上，并且“即插即用”。</p><h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><blockquote><p>由于混入类在稍复杂的应用形式下（例如某混入类依赖其他多个混入类），会导致JS自动的类型推断失效，所以我下面都会使用TS来书写，实际上JS也完全没问题。</p></blockquote><p>假设这是一个UI组件类，现在要通过一个能检测组件可见性的外部库，为这个组件类添加两个相关钩子。</p><pre class="line-numbers language-ts" data-language="ts"><code class="language-ts">class ViewComponent &#123;
  onCreate() &#123;&#125;
  onDispose() &#123;&#125;

  &#x2F;&#x2F; 此处为ts的语法糖，等同于声明了一个私有成员，并在构造函数中赋值
  constructor(private name: string) &#123;&#125;  
&#125;

&#x2F;&#x2F; 假设这是一个可以监听组件可见性的外部库
class ViewVisibleObserver &#123;
  constructor(context) &#123;&#125;
  addHandler(handler) &#123;&#125;
  removeHandler() &#123;&#125;
  destroy() &#123;&#125;
&#125;</code></pre><p>如果要想为<code>ViewComponent</code>增加检测自身可见性的功能，在已经有封装好的库的情况下，至少还需要：</p><ul><li>一个用于存储<code>ViewVisibleObserver</code>实例的变量</li><li>注册监听处理函数的逻辑</li><li>在组件销毁时同时销毁<code>ViewVisibleObserver</code>实例的逻辑<br>然而这些逻辑在不使用混入类的情况下，只能通过继承。如上述所言，假设还有更多要增加的功能，会导致难以使用等诸多问题。</li></ul><p>下面是混入类的声明。假设混入类<code>MixinLeaveOnScreenAware</code>为被混入类提供<code>onHide</code>和<code>onShow</code>两个钩子。</p><pre class="line-numbers language-ts" data-language="ts"><code class="language-ts">const MixinLeaveOnScreenAware &#x3D; (C: typeof ViewComponent) &#x3D;&gt; class extends C &#123;
  #screenVisibleObserver &#x3D; new ViewVisibleObserver(this)
  onHide() &#123;&#125;
  onShow() &#123;&#125;

  onCreate() &#123;
    super.onCreate()  &#x2F;&#x2F; 重写的方法不要忘记调用父类上的同名方法哦~
    this.#screenVisibleObserver.addHandler(visible &#x3D;&gt; visible ? this.onShow() : this.onHide())
  &#125;

  onDispose() &#123;
    super.onCreate()
    this.#screenVisibleObserver.destroy()
  &#125;
&#125;</code></pre><p>可以看到，虽然称作“类”，但实际上是一个<strong>返回了继承后的类的函数</strong>。接下来是混入类的使用。</p><pre class="line-numbers language-ts" data-language="ts"><code class="language-ts">&#x2F;&#x2F; 注意这里的写法，将要混入的类以类似函数调用的形式，被混入类作为参数传入
&#x2F;&#x2F; 参数是要继承的类，如有多个要混入的类，可以继续以洋葱的形式嵌套，例如MixinB( MixinA( ViewComponent ) )
class HeaderView extends MixinLeaveOnScreenAware(ViewComponent) &#123;
  constructor(
    public title: string
  ) &#123;
    super(&#39;headerView&#39;)  &#x2F;&#x2F; 在编辑器中可以发现，即使不用TS，包括调用父类构造函数时类型推断也都是正常的
  &#125;

  onCreate() &#123;
    super.onCreate()
    console.log(&#39;create&#39;)
  &#125;

  onShow() &#123;
    super.onShow()
    console.log(&#39;show&#39;)
  &#125;
&#125;

const headerView &#x3D; new HeaderView(&#39;首页&#39;)</code></pre><p>从<code>extands</code>后的写法可以看出，JS的<code>extends</code>关键字实际上类似一个操作符，后面无论什么是内容，只要返回的是一个类即可。这也得益于JS可以将class本身当作参数来传递。</p><p>另外可能有的小伙伴已经想到了，使用装饰器同样也是可以实现得非常优雅，但有装饰器有一些问题：</p><ul><li>JS原生还不支持装饰器，需要引入额外的语法转换处理才能使用</li><li>装饰器模式原则上不改变类的接口结构。也就是说混入了什么新变量或者新方法，都不会在自动的类型推断中反映出来（虽然不影响使用，但不优雅啊&gt;_&lt;，另外TS也会报错）。</li></ul><h2 id="进阶与类型支持"><a href="#进阶与类型支持" class="headerlink" title="进阶与类型支持"></a>进阶与类型支持</h2><h3 id="优化洋葱写法"><a href="#优化洋葱写法" class="headerlink" title="优化洋葱写法"></a>优化洋葱写法</h3><p>在使用多个混入类时，洋葱写法会变得非常难看，可以实现一个<code>mixins</code>函数将洋葱写法扁平化。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">function mixins(C, ...mixinClasses) &#123;
  return mixinClasses.reduce((result, mixinClass) &#x3D;&gt; mixinClass(result), C)
&#125;

&#x2F;&#x2F; 假设再实现一个在组件恢复显示时复原滚动条进度的混入类，该类依赖MixinLeaveOnScreenAware
const MixinScrollRestorableOnVisibleChanged &#x3D; (Base) &#x3D;&gt; class extends Base &#123;
  #scrollValue &#x3D; 0

  onShow() &#123;
    super.onShow()
    this.restoreScrollPosition()
  &#125;

  onHide() &#123;
    super.onHide()
    this.saveScrollPosition()
  &#125;

  restoreScrollPosition() &#123;&#125;

  saveScrollPosition() &#123;
    this.#scrollValue &#x3D; 100
  &#125;
&#125;

&#x2F;&#x2F; 使用
class FooterView extends mixins(ViewComponent,
  MixinLeaveOnScreenAware,  &#x2F;&#x2F; 由于MixinScrollRestorableOnVisibleChanged依赖该混合类，所以必须先混入
  MixinScrollRestorableOnVisibleChanged
) &#123; 
  constructor() &#123;
    super(&#39;footerView&#39;)
  &#125;
&#125;

const footerView &#x3D; new FooterView()</code></pre><h3 id="TS下的类型支持准备"><a href="#TS下的类型支持准备" class="headerlink" title="TS下的类型支持准备"></a>TS下的类型支持准备</h3><p>可能需要一些TS相关知识。首先声明5个工具类型。</p><pre class="line-numbers language-ts" data-language="ts"><code class="language-ts">&#x2F;&#x2F; 通用的类模型类型
type ClassModel&lt;Args extends any[] &#x3D; any[], Return &#x3D; any&gt; &#x3D; new (...args: Args) &#x3D;&gt; Return
&#x2F;&#x2F; 混入类
type MixinClass &#x3D; (C: ClassModel) &#x3D;&gt; ClassModel
&#x2F;&#x2F; 被混入类
type MixinClassBase&lt;T extends ClassModel, U extends MixinClass[]&gt; &#x3D; ClassModel&lt;ConstructorParameters&lt;T&gt;, CombineMixinClassInstanceTupleType&lt;U&gt;&gt;

&#x2F;&#x2F; 这两个类型用于递归得出使用的全部混入类实例的交叉类型，原理见文章最下方的“参见”章节的“深入理解 TypeScript 高级用法”
type ShiftAction&lt;T extends any[]&gt; &#x3D; ((...args: T) &#x3D;&gt; any) extends ((arg1: any, ...rest: infer R) &#x3D;&gt; any) ? R : never
type CombineMixinClassInstanceTupleType&lt;T extends MixinClass[], E &#x3D; &#123;&#125;&gt; &#x3D; &#123;
  1: E,
  0: CombineMixinClassInstanceTupleType&lt;ShiftAction&lt;T&gt;, E &amp; InstanceType&lt;ReturnType&lt;T[0]&gt;&gt;&gt;
&#125;[T extends [] ? 1 : 0]</code></pre><h3 id="类型支持的mixins函数"><a href="#类型支持的mixins函数" class="headerlink" title="类型支持的mixins函数"></a>类型支持的<code>mixins</code>函数</h3><p>注意：<code>mixins</code>函数只能提供构造函数参数及最终实例的类型支持，对于混入类所需的顺序没办法限制。例如<code>MixinB</code>依赖<code>MixinA</code>，此时必须先混入A再混入B，像是Dart等原生支持混入类的语言，混入顺序不对时在编码阶段就会提示。</p><pre class="line-numbers language-ts" data-language="ts"><code class="language-ts">function mixins&lt;T extends ClassModel, U extends MixinClass[]&gt;(C: T, ...mixinClasses: U)
    : ClassModel&lt;ConstructorParameters&lt;T&gt;, CombineMixinClassInstanceTupleType&lt;U&gt;&gt; &#123;
  return mixinClasses.reduce((result, mixinClass) &#x3D;&gt; mixinClass(result), C as any)
&#125;</code></pre><h3 id="类型支持的混入类"><a href="#类型支持的混入类" class="headerlink" title="类型支持的混入类"></a>类型支持的混入类</h3><pre class="line-numbers language-ts" data-language="ts"><code class="language-ts">const MixinScrollRestorableOnVisibleChanged &#x3D; (
  &#x2F;&#x2F; 注意这里的写法，第一个泛型传入被混合类，第二个泛型传入一个由全部要使用的混合类组成的元组
  Base: MixinClassBase&lt;typeof ViewComponent, [
    typeof MixinLeaveOnScreenAware,
  ]&gt;
) &#x3D;&gt; class extends Base &#123;
  #scrollValue &#x3D; 0

  onShow() &#123;
    super.onShow()
    this.restoreScrollPosition()
  &#125;

  onHide() &#123;
    super.onHide()
    this.saveScrollPosition()
  &#125;

  restoreScrollPosition() &#123;&#125;

  saveScrollPosition() &#123;
    this.#scrollValue &#x3D; 100
  &#125;
&#125;

&#x2F;&#x2F; 使用
class FooterView extends mixins(ViewComponent,
  MixinLeaveOnScreenAware,
  MixinScrollRestorableOnVisibleChanged
) &#123; 
  constructor() &#123;
    super(&#39;footerView&#39;)
  &#125;
&#125;

const footerView &#x3D; new FooterView()</code></pre><h2 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h2><ul><li>难以分辨哪些实例成员是混入类添加的，又是哪个特定混入类添加的。不过这是类似模式的通病，例如React + Redux，会向<code>props</code>注入内容，当注入的来源过多时也会出现类似问题。可以通过特殊的命名等方式解决。</li><li>混入类在依赖其他混入类的情况下，顺序没有约束的手段</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>extends</code>关键字后可以跟任意返回class的表达式，这一点令我十分震惊，也是JS混入类实现的必要条件。我也是最近偶然中在MDN上看到的，本质上来说是实现了一种更灵活的继承方式。相信随着Vue3.0、AngularJS等以class为基础的框架，以及Web Component的发展，混入类一定会在其中占有一席之地，这是我一次在掘金上发布文章，如有错误之处，欢迎大家指出。</p><h2 id="参见"><a href="#参见" class="headerlink" title="参见"></a>参见</h2><ul><li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes#mix-ins_%E6%B7%B7%E5%85%A5">MDN中对于类的Mix-ins / 混入的介绍</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/136254808"># 【万字长文】深入理解 TypeScript 高级用法</a></li></ul></div><div class="articleLicenses"><p>版权声明：本文为原创文章，版权归 小春日和 所有</p><p style="word-break:break-all"><span>文章链接：</span><a id="articleLink" href="javascript:void()" aria-describedby="tooltip-copyArticleLink">https://koharubiyori.github.io/JavaScript/JavaScript之类的混入/</a></p><p><span>所有原创文章采用&nbsp;</span><a target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh">署名-非商业性使用 4.0 国际 (CC BY-NC 4.0)</a></p><p>您可以自由转载和修改，但必须保证在显著位置注明文章来源，且不能用于商业目的。</p><div id="tooltip-copyArticleLink" class="mdc-tooltip" role="tooltip" aria-hidden="true"><div class="mdc-tooltip__surface"><lorem>点击复制链接</lorem></div></div></div></div></div><div class="prevNextArticle flex-row flex-between"><a class="nextArticle materialRipple materialRipple--dark mdc-elevation--z2 flex" href="/Electron/Electron渲染进程调用主进程模块探索/" title="Electron渲染进程调用主进程模块探索"><div class="label">上一篇</div><div class="title com-textLimit">Electron渲染进程调用主进程模块探索</div></a><a class="prevArticle materialRipple materialRipple--dark mdc-elevation--z2 flex" href="/Windows/Windows环境变量配置之坑人的[U+202A]/" title="Windows环境变量配置之坑人的[U+202A]"><div class="label">下一篇</div><div class="title com-textLimit">Windows环境变量配置之坑人的[U+202A]</div></a></div><div id="post-comments"></div></div></main><div class="page-sidebar"><div class="sidebar-placeholder"></div><div class="sidebar-body mdc-elevation--z4"><div class="articleContents"><div class="articleContents-title">目录</div></div><div class="katakoto"><div class="katakoto-title">只言片语</div><div class="katakoto-items"><div class="katakoto-item"><div class="katakoto-item--content">第三次重建博客，希望这次不会没写多少东西就又关了...</div><div class="katakoto-item--date">—— 2020年11月21日 09:35</div></div><div class="katakoto-item"><div class="katakoto-item--content">其实我写博客是为了发图的...なんちゃって</div><div class="katakoto-item--date">—— 2020年12月05日 23:35</div></div><div class="katakoto-item"><div class="katakoto-item--content">希望以后每天都能开心...</div><div class="katakoto-item--date">—— 2020年12月07日 10:14</div></div><div class="katakoto-item"><div class="katakoto-item--content">少想多做。</div><div class="katakoto-item--date">—— 2022年07月03日 00:14</div></div></div></div><div class="tags"><div class="tags-title">内容标签</div><a class="tags-item" href="/tags/Electron/" title="查看“Electron”标签下的文章"><i class="material-icons">local_offer</i><span>Electron</span></a><a class="tags-item" href="/tags/Flutter/" title="查看“Flutter”标签下的文章"><i class="material-icons">local_offer</i><span>Flutter</span></a><a class="tags-item" href="/tags/JavaScript/" title="查看“JavaScript”标签下的文章"><i class="material-icons">local_offer</i><span>JavaScript</span></a><a class="tags-item" href="/tags/TypeScript/" title="查看“TypeScript”标签下的文章"><i class="material-icons">local_offer</i><span>TypeScript</span></a><a class="tags-item" href="/tags/前端/" title="查看“前端”标签下的文章"><i class="material-icons">local_offer</i><span>前端</span></a><a class="tags-item" href="/tags/React/" title="查看“React”标签下的文章"><i class="material-icons">local_offer</i><span>React</span></a><a class="tags-item" href="/tags/Vue-js/" title="查看“Vue.js”标签下的文章"><i class="material-icons">local_offer</i><span>Vue.js</span></a><a class="tags-item" href="/tags/前端技术/" title="查看“前端技术”标签下的文章"><i class="material-icons">local_offer</i><span>前端技术</span></a><a class="tags-item" href="/tags/Windows/" title="查看“Windows”标签下的文章"><i class="material-icons">local_offer</i><span>Windows</span></a><a class="tags-item" href="/tags/小程序/" title="查看“小程序”标签下的文章"><i class="material-icons">local_offer</i><span>小程序</span></a><a class="tags-item" href="/tags/Taro/" title="查看“Taro”标签下的文章"><i class="material-icons">local_offer</i><span>Taro</span></a><a class="tags-item" href="/tags/日常/" title="查看“日常”标签下的文章"><i class="material-icons">local_offer</i><span>日常</span></a></div></div></div><div class="page-search"><div class="search-body"><div class="search-input-container flex-row flex-cross-center"><i class="material-icons">search</i><input class="search-input flex" placeholder="搜索文章..."></div><div class="search-result" data-dirty="false" data-emptyresult="false"></div></div></div></div><div class="backTopButton mdc-elevation--z4 flex-row flex-center is-hide materialRipple"><i class="material-icons">north</i></div></body></html>