<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="baidu-site-verification" content="code-huaq5qAbeF"><title>记一次大量调整组件参数的经历 - 小春日和の秘密基地</title><meta name="description" content="AST，yyds"><link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@5.8.55/css/materialdesignicons.min.css"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><link rel="stylesheet" href="/libs/normalize.css?timestamp=1714273544228"><link rel="stylesheet" href="/libs/flex.css?timestamp=1714273544228"><link rel="stylesheet" href="/libs/material-components-web.min.css?timestamp=1714273544228"><link rel="stylesheet" href="/libs/mdc.tooltip.min.css?timestamp=1714273544228"><link rel="stylesheet" href="/libs/prism.css?timestamp=1714273544228"><link rel="stylesheet" href="/libs/viewer.min.css?timestamp=1714273544228"><link rel="stylesheet" href="/styles/commons/index.css?timestamp=1714273544228"><link rel="stylesheet" href="/styles/templates/index.css?timestamp=1714273544228"><link rel="stylesheet" href="/styles/partial/index.css?timestamp=1714273544228"><link rel="stylesheet" href="/styles/layout.css?timestamp=1714273544228"><script src="/libs/jquery.min.js?timestamp=1714273544228"></script><script src="/libs/material-components-web.min.js?timestamp=1714273544228"></script><script src="/libs/mdc.tooltip.min.js?timestamp=1714273544228"></script><script src="/libs/prism.min.js?timestamp=1714273544228"></script><script src="/libs/viewer.min.js?timestamp=1714273544228"></script><script src="/scripts/uiRender.js?timestamp=1714273544228"></script><meta name="generator" content="Hexo 5.0.2"></head><body><img class="page-bgImg" src="/sourceImages/bg.png"><header class="mdc-top-app-bar mdc-top-app-bar--fixed mdc-elevation--z4"><div class="mdc-top-app-bar__row"><section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start"><button id="drawerButton" class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button">menu</button> <a class="mdc-top-app-bar__title" href="/" style="color:#fff">小春日和の秘密基地</a></section><section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end"><button id="searchButton" class="material-icons mdc-top-app-bar__action-item mdc-icon-button">search</button></section></div></header><div class="mainContainer flex-row"><div class="page-drawer"><div class="drawer-placeholder"></div><aside class="mdc-drawer drawer-body mdc-elevation--z4"><div class="drawer-header flex-column flex-evenly"><div class="drawer-header--content flex-column flex-cross-center"><img class="drawer-avatar" src="/sourceImages/avatar.png"><div class="drawer-userName">小春日和</div><div class="drawer-totals flex-row flex-cross-center"><div class="flex flex-column flex-center"><div class="drawer-totals--label">文章</div><div class="drawer-totals--value">共14篇</div></div><div class="flex flex-column flex-center"><div class="drawer-totals--label">标签</div><div class="drawer-totals--value">共12个</div></div><div class="flex flex-column flex-center" id="busuanzi_container_site_pv"><div class="drawer-totals--label" style="text-align:center">总访问</div><div class="drawer-totals--value" style="text-align:center"><span id="busuanzi_value_site_pv"></span><span>次</span></div></div></div></div></div><div class="drawer-content"><div class="drawer-list"><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" href="/"><i class="list-item--icon material-icons">home</i><span class="list-item--title">首页</span></a><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" href="/日常/再次启程"><i class="list-item--icon material-icons">info</i><span class="list-item--title">关于博客 </span></a><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" target="_blank" rel="noopener" href="https://github.com/koharubiyori"><i class="mdi-set mdi-github" style="font-size:24px;color:var(--mdc-theme-primary);line-height:1.1"></i><span class="list-item--title">Github</span></a><a class="drawer-list-item flex-row flex-cross-center materialRipple materialRipple--dark com-pointer" target="_blank" rel="noopener" href="https://zh.moegirl.org.cn/User:%E6%9D%B1%E6%9D%B1%E5%90%9B"><strong style="font-size:18px;color:var(--mdc-theme-primary);margin-left:3px">萌</strong><span class="list-item--title">萌娘百科</span></a></div></div></aside></div><main class="mainContent flex"><div class="page-post"><link rel="stylesheet" href="/styles/post.css?timestamp=1714273544197"><div class="post-header"><h2 class="post-header--title">记一次大量调整组件参数的经历</h2><div class="post-header--row com-onlyDesktop"><div class="post-header--infoBox" style="background-color:#007fff"><i class="material-icons">watch_later</i><span>2021年06月11日</span></div><div class="post-header--infoBox" style="background-color:#04b431"><i class="material-icons">menu_book</i><span>总字数：1.4k</span></div><div class="post-header--infoBox" style="background-color:#b40486"><i class="material-icons">access_alarm</i><span>预计阅读时间：17分钟</span></div></div><div class="post-header--row post-header--tags" style="justify-content:flex-start;margin-top:10px"><a class="post-header--tag" href="/tags/JavaScript/" title="查看“JavaScript”标签下的文章"><i class="material-icons">local_offer</i><span>JavaScript</span></a><a class="post-header--tag" href="/tags/前端/" title="查看“前端”标签下的文章"><i class="material-icons">local_offer</i><span>前端</span></a></div></div><div class="post-body mdc-elevation--z2"><img class="post-body--headImg" src="https://snz04pap001files.storage.live.com/y4mqHugniRcgkbB7E5ZgG6C8xCN2J-gqB5OZk0_pC7B_L4TZyDGZ6rv4Du3SJFJKg6IKy1_jaXM1OFaf0g1KovRyrLf39Pn5aMSPx0ThUaSnCDjKYTU-bVg9_hh1Q6N4JciPu1F_M_iqZghXHEcaMihViYTV27_dL-Fsk42UywVX413_7_WL3mkC-sSwIgW_MEH?width=1024&amp;height=576&amp;cropmode=none" style="object-position:undefined"><div class="post-body--content"><div class="contentContainer"><p>图片来源：<a target="_blank" rel="noopener" href="https://www.pixiv.net/artworks/61538563">pixiv:こっちの世界が気になるフレンズ 作者：ｍ－くん</a></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Gitee pages上挂的这个静态博客，全都是技术文章博客被以政治敏感封禁了。询问客服，说我的博客里有敏感词，难道是日文？如果是日文的话，那Gitee确实不适合我。</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>公司的管理后台系统中某几个类型的下拉筛选框全部都需要添加一个选项搜索的功能，虽然这个功能组件库已经提供，但涉及到数十个页面页面中上百个筛选框，修改起来仍是个不小的问题，经过考虑后得出了4种解决方案：</p><ol><li>手动修改，缺点最多，工作量极大且容易出错，作为最后选择</li><li>正则表达式匹配筛选框代码块，进行替换，最终因为要匹配的情况太多，单靠正则出错的可能较大，放弃</li><li>为筛选框组件添加一个代理层进行处理，缺点是会导致组件行为和组件库的文档出现差异，对理解上造成混乱，因此作为备选</li><li>使用基于代码分析的代码修改工具，技术上没有缺点，就是之前没有接触过，这也是这篇文章的主题</li></ol><p>2021年10月11日追记：也可通过<code>patch-package</code>修改UI库代码中的默认值来实现，但缺点同3。</p><h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>之前闲着没事逛掘金的时候看到了阿里名下一个叫做“<a target="_blank" rel="noopener" href="https://github.com/thx/gogocode">GoGoCode</a>”的AST处理库，正好中文文档对于刚开始接触这种工具的我也比较好理解。</p><p>公司项目使用React + antd UI组件库开发。</p><p>需要将A、B、C、D、E、F(涉及公司业务，这里使用字母代替)这几个类型的筛选框添加选项搜索的功能，要为这几种类型的筛选框添加<code>showSearch</code>以及<code>optionFilterProp</code>属性，同时还要将一部分代码中现有的<code>showSearch=&#123;false&#125;</code>去掉。</p><p>首先按照<a target="_blank" rel="noopener" href="https://gogocode.io/zh/docs/specification/replace">文档中的示例</a>：</p><blockquote><p><code>$_$1</code> 和 <code>$_$2</code> 相当于正则中的通配符，但是在这里只会匹配代码里有效的 AST 节点<br><code>$$$1</code> <code>$$$2</code> 则可以匹配剩下的节点，有点像 es6 里的 …，体现在AST结构里，$$$节点需要在数组属性内</p></blockquote><pre class="line-numbers language-js" data-language="js"><code class="language-js">.replace(
  &#39;&lt;Select $$$1 placeholder&#x3D;&quot;A&quot; $$$2&gt;$$$3&lt;&#x2F;Select&gt;&#39;,
  &#39;&lt;Select showSearch $$$1 placeholder&#x3D;&quot;A&quot; $$$2 optionFilterProp&#x3D;&quot;children&quot;&gt;$$$3&lt;&#x2F;Select&gt;&#39;
)</code></pre><p>不出意外地失败了，猜测可能是<code>$$$</code>不会匹配空节点的情况，例如可能无法匹配<code>&lt;Select placeholder&quot;a&quot;&gt;&lt;/Select&gt;</code>这样的代码。<br>看来单靠<code>replace</code>方法是无法实现我需要的操作了，接下来只好使用<code>each</code>方法去遍历，这样就是不得不面对一个问题——需要手动获取并操作节点：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">&#x2F;&#x2F; glob是一个使用minimatch库进行文件匹配的库，具体使用请google ?? baidu
glob(&#39;src&#x2F;**&#x2F;*.@(js|ts|jsx|tsx)&#39;, (err, filePaths) &#x3D;&gt; &#123;
  if (err) throw err
  filePaths.forEach(filePath &#x3D;&gt; &#123;
    const result &#x3D; $.loadFile(filePath, &#123;
      parseOption: &#123; plugins: [&#39;jsx&#39;] &#125;
    &#125;)
      .find(&#39;&lt;Select $$$1&gt;$$$2&lt;&#x2F;Select&gt;&#39;) &#x2F;&#x2F; 首先匹配参数和内容
      .each(item &#x3D;&gt; &#123;
        const attributes &#x3D; getAttrs(item.match[&#39;$$$1&#39;])
        &#x2F;&#x2F; 获取jsx节点的参数map
        function getAttrs(nodes) &#123;
          return Object.fromEntries(
            nodes.map(item &#x3D;&gt; &#123;
              &#x2F;&#x2F; name为空，不知道是什么原因，这里返回一个null用于接下来滤掉
              if (item.name &#x3D;&#x3D;&#x3D; undefined) return null
              return [
                item.name.name, &#x2F;&#x2F; 属性名
                item.value ? item.value.value : undefined  &#x2F;&#x2F; 属性值，若为jsx简写属性，则没有值
              ]
            &#125;)
            .filter(item &#x3D;&gt; !!item)   &#x2F;&#x2F; 滤掉name为空的项
          )
        &#125;

        &#x2F;&#x2F; 拿到全部筛选框的属性后，就可以进一步的缩小范围，得出需要修改的筛选框了

        &#x2F;&#x2F; 筛选placeholder为A,B,C,D,E,F的筛选框。
        if ([&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39;].includes(attributes.placeholder)) &#123;
          &#x2F;&#x2F; item.node.openingElement属性上保存着当前节点的信息，关于这个属性文档上并没有介绍，需要手动debug查看
          &#x2F;&#x2F; 这里需要将节点上已有的showSearch和optionFilterProp去掉，否则输出的代码会发生属性重复
          item.node.openingElement.attributes &#x3D; item.node.openingElement.attributes
            .filter(item &#x3D;&gt; [&#39;showSearch&#39;, &#39;optionFilterProp&#39;].includes(item.name.name) &#x3D;&#x3D;&#x3D; false)

          &#x2F;*
            向节点添加属性，该方法是在节点的core属性上的，在调用时第一个参数需要将节点本身传入，
            关于core属性，该属性带有很多操作节点的方法，不过这个属性仍然没有在文档中介绍，
            谷歌了一番发现了个貌似是同一家叫GoGoAST的库(作者为阿里员工)：https:&#x2F;&#x2F;github.com&#x2F;shuerguo999&#x2F;gogoAST，
            可以参考GoGoAST的文档调用core属性上的方法
          *&#x2F;
          item.core.appendJsxAttr(item, &#123;
            optionFilterProp: &#96;&#39;children&#39;&#96;,   &#x2F;&#x2F; 注意这里的写法
            showSearch: &#39;&#123;true&#125;&#39;
          &#125;)
        &#125;

        &#x2F;&#x2F; 最后，拼接文件的输出路径
        const targetPath &#x3D; path.join(&#39;output&#39;, filePath)

        &#x2F;&#x2F; 导出文件
        try &#123;
          &#x2F;&#x2F; results是导出的代码内容
          $.writeFile(result, targetPath)
        &#125; catch(e) &#123;
          fs.mkdirSync(path.join(targetPath, &#39;..&#x2F;&#39;), &#123; recursive: true &#125;)
          $.writeFile(result, targetPath)
        &#125;
      &#125;)
  &#125;)
&#125;)</code></pre><p>以上，就完成了使用GoGoCode批量修改代码的逻辑。</p><h2 id="参见"><a href="#参见" class="headerlink" title="参见"></a>参见</h2><ul><li><a target="_blank" rel="noopener" href="https://gogocode.io/zh">GoGoCode</a></li><li><a target="_blank" rel="noopener" href="https://github.com/shuerguo999/gogoAST">GoGoAST</a></li></ul></div><div class="articleLicenses"><p>版权声明：本文为原创文章，版权归 小春日和 所有</p><p style="word-break:break-all"><span>文章链接：</span><a id="articleLink" href="javascript:void()" aria-describedby="tooltip-copyArticleLink">https://koharubiyori.github.io/JavaScript/记一次大量调整组件参数的经历/</a></p><p><span>所有原创文章采用&nbsp;</span><a target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh">署名-非商业性使用 4.0 国际 (CC BY-NC 4.0)</a></p><p>您可以自由转载和修改，但必须保证在显著位置注明文章来源，且不能用于商业目的。</p><div id="tooltip-copyArticleLink" class="mdc-tooltip" role="tooltip" aria-hidden="true"><div class="mdc-tooltip__surface"><lorem>点击复制链接</lorem></div></div></div></div></div><div class="prevNextArticle flex-row flex-between"><a class="nextArticle materialRipple materialRipple--dark mdc-elevation--z2 flex" href="/JavaScript/WebWorker与主线程的三种通信方式/" title="WebWorker与主线程的三种通信方式"><div class="label">上一篇</div><div class="title com-textLimit">WebWorker与主线程的三种通信方式</div></a><a class="prevArticle materialRipple materialRipple--dark mdc-elevation--z2 flex" href="/Electron/Electron渲染进程调用主进程模块探索/" title="Electron渲染进程调用主进程模块探索"><div class="label">下一篇</div><div class="title com-textLimit">Electron渲染进程调用主进程模块探索</div></a></div><div id="post-comments"></div></div></main><div class="page-sidebar"><div class="sidebar-placeholder"></div><div class="sidebar-body mdc-elevation--z4"><div class="articleContents"><div class="articleContents-title">目录</div></div><div class="katakoto"><div class="katakoto-title">只言片语</div><div class="katakoto-items"><div class="katakoto-item"><div class="katakoto-item--content">第三次重建博客，希望这次不会没写多少东西就又关了...</div><div class="katakoto-item--date">—— 2020年11月21日 09:35</div></div><div class="katakoto-item"><div class="katakoto-item--content">其实我写博客是为了发图的...なんちゃって</div><div class="katakoto-item--date">—— 2020年12月05日 23:35</div></div><div class="katakoto-item"><div class="katakoto-item--content">希望以后每天都能开心...</div><div class="katakoto-item--date">—— 2020年12月07日 10:14</div></div><div class="katakoto-item"><div class="katakoto-item--content">少想多做。</div><div class="katakoto-item--date">—— 2022年07月03日 00:14</div></div></div></div><div class="tags"><div class="tags-title">内容标签</div><a class="tags-item" href="/tags/Electron/" title="查看“Electron”标签下的文章"><i class="material-icons">local_offer</i><span>Electron</span></a><a class="tags-item" href="/tags/JavaScript/" title="查看“JavaScript”标签下的文章"><i class="material-icons">local_offer</i><span>JavaScript</span></a><a class="tags-item" href="/tags/TypeScript/" title="查看“TypeScript”标签下的文章"><i class="material-icons">local_offer</i><span>TypeScript</span></a><a class="tags-item" href="/tags/前端/" title="查看“前端”标签下的文章"><i class="material-icons">local_offer</i><span>前端</span></a><a class="tags-item" href="/tags/Flutter/" title="查看“Flutter”标签下的文章"><i class="material-icons">local_offer</i><span>Flutter</span></a><a class="tags-item" href="/tags/React/" title="查看“React”标签下的文章"><i class="material-icons">local_offer</i><span>React</span></a><a class="tags-item" href="/tags/Vue-js/" title="查看“Vue.js”标签下的文章"><i class="material-icons">local_offer</i><span>Vue.js</span></a><a class="tags-item" href="/tags/前端技术/" title="查看“前端技术”标签下的文章"><i class="material-icons">local_offer</i><span>前端技术</span></a><a class="tags-item" href="/tags/Windows/" title="查看“Windows”标签下的文章"><i class="material-icons">local_offer</i><span>Windows</span></a><a class="tags-item" href="/tags/日常/" title="查看“日常”标签下的文章"><i class="material-icons">local_offer</i><span>日常</span></a><a class="tags-item" href="/tags/小程序/" title="查看“小程序”标签下的文章"><i class="material-icons">local_offer</i><span>小程序</span></a><a class="tags-item" href="/tags/Taro/" title="查看“Taro”标签下的文章"><i class="material-icons">local_offer</i><span>Taro</span></a></div></div></div><div class="page-search"><div class="search-body"><div class="search-input-container flex-row flex-cross-center"><i class="material-icons">search</i><input class="search-input flex" placeholder="搜索文章..."></div><div class="search-result" data-dirty="false" data-emptyresult="false"></div></div></div></div><div class="backTopButton mdc-elevation--z4 flex-row flex-center is-hide materialRipple"><i class="material-icons">north</i></div></body></html>